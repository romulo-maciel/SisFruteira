<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <script>
        // window.cartAPI.addToCart((message) => {
        //     console.log('testar de onde vem isso',message);
        // })

        const changePage = (page) => {
            const pages = document.querySelectorAll('.container');
            pages.forEach((p) => {
                p.classList.add('hidden');
            });

            document.getElementById(page).classList.remove('hidden');
        }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/estoque.css">
    <link rel="stylesheet" href="css/header.css">
    <title>Fruteira NSª Aparecida</title>
    <script src="js/pdv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header>
        <img src="assets/logo.jpg" id="logo" alt="Logo da Fruteira NSª Aparecida">
        <h1>Fruteira NSª Aparecida</h1>
        <nav>
            <a class="header-nav-link" onclick="changePage('pdv')">PDV</a>
            <a class="header-nav-link" onclick="changePage('estoque')">Estoque</a>
            <a class="header-nav-link" onclick="changePage('relatorios')">Relatórios</a>
            <!-- <a class="header-nav-link" onclick="console.log(window.cartAPI.promptQuantity())">teste</a> -->
        </nav>
    </header>

    <main class="container" id="pdv">
        <section class="side" id="left-side-container">
            <img src="assets/logo.jpg" alt="logo" id="big-logo">
            <div class="cart-total">
                <p class="cart-total-title" style="font-weight: bold;">Total:</p>
                <p class="cart-total-value" id="cart-total">R$ 0,00</p>
            </div>
        </section>

        <section class="side" id="right-side-container">
            <div class="card-row">
                <div class="card-info">
                    <p class="card-title">Qtd:</p>
                    <p class="card-value" id="weight"></p>
                </div>
                <div class="card-info">
                    <p class="card-title">Valor:</p>
                    <p class="card-value" id="item-price"></p>
                </div>
            </div>
            <div class="product-input">
                <label for="code">Código do Produto</label>
                <input type="number" name="code" id="code" placeholder="Digite o código" autofocus>
            </div>
            <div class="product-input"></div>
            <div class="selected-product-card">
                <img src="" id="product-image" alt="Imagem do Produto">
                <div>
                    <p id="product-name">Nome do Produto</p>
                    <p id="product-price">Preço</p>
                </div>
            </div>

            <div class="cart-container">
                <table class="cart">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Preço Un.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="cart-list"></tbody>
                </table>
            </div>

            <div class="inline" style="margin-top: 15px; display: flex; justify-content: end">
                <input type="button" onclick="finishPurchase()" value="Finalizar Compra" id="finish-sale">
            </div>
        </section>
    </main>

    <main class="container hidden" id="estoque">
        <script>
            // Variável para armazenar o elemento que está sendo editado
            let currentEditingElement = null;

            // Função para renderizar os cards de produtos
            const populateCards = (fruits) => {
                const container = document.getElementById('estoque');
                const cards = fruits.map((fruit) => {
                    // Verifica se o preço é nulo ou indefinido
                    const priceDisplay = fruit.price === null || fruit.price === undefined 
                        ? '<span class="price-not-set">Preço não configurado</span>' 
                        : `R$ ${fruit.price.toFixed(2)}`;
                    
                    return `
                    <div class="fruit-card">
                        <img class="fruit-image" src="fruits/${fruit.image}" alt="${fruit.name}" width="50" height="50">
                        <div class="fruit-info">
                            <h2>${fruit.name}</h2>
                            <p class="fruit-price" data-code="${fruit.code}" data-price="${fruit.price}" onclick="startEditPrice(this)">Preço: ${priceDisplay}
                            </p>
                        </div>
                    </div>
                    `;
                });

                container.innerHTML = cards.join('');
            }

            // Função para iniciar a edição do preço
            function startEditPrice(element) {
                // Se já estiver editando outro elemento, cancela a edição anterior
                if (currentEditingElement && currentEditingElement !== element) {
                    cancelEditPrice();
                }

                // Marca o elemento atual como sendo editado
                currentEditingElement = element;
                
                // Obtém o código e preço atual do produto
                const code = element.getAttribute('data-code');
                const currentPrice = element.getAttribute('data-price');
                
                // Cria o HTML para o editor inline
                const editorHTML = `
                    <div class="price-editor">
                        <input type="number" class="price-input" value="${currentPrice !== 'null' ? currentPrice : ''}" step="0.01" min="0" placeholder="Digite o preço">
                        <div class="price-actions">
                            <button class="save-btn" onclick="savePrice('${code}')">Salvar</button>
                            <button class="cancel-btn" onclick="cancelEditPrice()">Cancelar</button>
                        </div>
                    </div>
                `;
                
                // Salva o conteúdo original para restaurar se necessário
                element.setAttribute('data-original-content', element.innerHTML);
                
                // Substitui o conteúdo pelo editor
                element.innerHTML = editorHTML;
                
                // Foca no input
                element.querySelector('.price-input').focus();
                
                // Previne o clique de propagar
                event.stopPropagation();
            }

            // Função para salvar o preço editado
            function savePrice(code) {
                if (!currentEditingElement) return;
                
                // Obtém o valor do input
                const input = currentEditingElement.querySelector('.price-input');
                const newPrice = input.value.trim();
                
                // Salva o novo preço no arquivo products.json
                const success = window.fruitsAPI.updatePrice(code, newPrice);
                
                if (success) {
                    // Atualiza o atributo data-price
                    const priceValue = newPrice === '' ? null : parseFloat(newPrice);
                    currentEditingElement.setAttribute('data-price', priceValue);
                    
                    // Atualiza a exibição do preço
                    const priceDisplay = priceValue === null 
                        ? '<span class="price-not-set">Preço não configurado</span>' 
                        : `R$ ${priceValue.toFixed(2)}`;
                    
                    currentEditingElement.innerHTML = `Preço: ${priceDisplay}`;
                    currentEditingElement = null;
                } else {
                    alert('Erro ao salvar o preço. Tente novamente.');
                }
            }

            // Função para cancelar a edição do preço
            function cancelEditPrice() {
                if (!currentEditingElement) return;
                
                // Restaura o conteúdo original
                const originalContent = currentEditingElement.getAttribute('data-original-content');
                currentEditingElement.innerHTML = originalContent;
                currentEditingElement = null;
            }

            // Adiciona um listener para fechar a edição ao clicar fora
            document.addEventListener('click', function(event) {
                if (currentEditingElement && !currentEditingElement.contains(event.target)) {
                    cancelEditPrice();
                }
            });

            window.onload = () => {
                const fruits = Object.values(window.fruitsAPI.getFruits());
                populateCards(fruits);
            }
        </script>
    </main>

    <main class="container hidden" id="relatorios">
        <h2 class="title">Relatórios</h2>
        <table id="report-grid">
            <thead>
                <tr>
                    <th scope="col">Produto</th>
                    <th scope="col">Quantidade</th>
                    <th scope="col">Preço Un.</th>
                    <th scope="col">Total</th>
                </tr>
            </thead>
            <tbody id="report-body">
                <!-- Dados serão inseridos aqui -->
            </tbody>
        </table>
        <canvas id="quantity-chart"></canvas>
    </main>

</body>

</html>